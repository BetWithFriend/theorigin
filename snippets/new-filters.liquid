{{ 'horizontal-bubbles.css' | asset_url | stylesheet_tag }}
{{ 'component-show-more.css' | asset_url | stylesheet_tag }}
<div class="all-new-filters-wrapper">
  <button onclick="toggleSortMenu(this)" class="sort-dropdown-button" type="button" aria-expanded="false" aria-haspopup="true">
    {% comment %} <div class="sort-icon-wrapper"> {% endcomment %}
      <div class="sort-text-wrapper">
        סינון לפי:
      </div>
      <img class="sort-icon-image" src="{{ 'sort-icon-image.png' | asset_url }}" alt="sort icon"/>
      <div class="sort-icon-image-selected {% if content_for_header contains 'filter.p.' or content_for_header contains 'filter.v.' or content_for_header contains 'sort_by=' %}show{% endif %}">&nbsp;</div>
    {% comment %} </div> {% endcomment %}
  </button>
  <div class="vertical-line-border">&nbsp;</div>
  <div class="sort-dropdown-menu" id="sortDropdownMenu">
    {% assign product_taste = collection.products %} 
    {% render 'taste-filter', tastes: product_taste, results: results %} 
  </div>
    <div class="horizontal-bubbles-wrapper" id="horizontal-bubbles-wrapper">
        <div class="horizontal-bubbles-container">
            <div class="bubble-item" onclick="goToFilter(this, 'filter.p.m.custom.coffee_roast_level', 'כהה, בינונית-כהה')">
                <div class="bubble-text">
                    <div class="bubble-title">קלייה כהה</div>
                    <div class="bubble-subtitle">אספרסו ומקינטה</div>
                </div>
            </div>

            <div class="bubble-item" onclick="goToFilter(this, 'filter.p.m.custom.coffee_roast_level', 'בינונית,בינונית-כהה')">
                <div class="bubble-text">
                    <div class="bubble-title">קלייה בינונית</div>
                    <div class="bubble-subtitle">מתאים להכל</div>
                </div>
            </div>

            <div class="bubble-item" onclick="goToFilter(this, 'filter.p.m.custom.coffee_roast_level', 'בהירה-בינונית,בהירה')">
                <div class="bubble-text">
                    <div class="bubble-title">קלייה בהירה</div>
                    <div class="bubble-subtitle">בעיקר לפילטר</div>
                </div>
            </div>

            <div class="bubble-item" onclick="goToFilter(this, 'filter.p.m.custom.coffee_process', 'שטוף, חצי-שטוף, אנאירובי שטוף')">
                <div class="bubble-text">
                    <div class="bubble-title">עיבוד שטוף</div>
                    <div class="bubble-subtitle">טעם נקי</div>
                </div>
            </div>

            <div class="bubble-item" onclick="goToFilter(this, 'filter.p.m.custom.coffee_process', 'טבעי, חצי-טבעי, אנאירובי טבעי, דבש')">
                <div class="bubble-text">
                    <div class="bubble-title">עיבוד טבעי</div>
                    <div class="bubble-subtitle">מתיקות טבעית</div>
                </div>
            </div>

            <div class="bubble-item" onclick="goToFilter(this, 'filter.p.m.custom.coffee_process', 'אנאירובי שטוף, אנאירובי טבעי')">
                <div class="bubble-text">
                    <div class="bubble-title">עיבוד אנאירובי</div>
                    <div class="bubble-subtitle">טעם מורכב</div>
                </div>
            </div>
        </div>
      </div>


    </div>
  </div>
</div>

  
<script>

  function removeAllFilters() {
    const params = new URLSearchParams(window.location.search);
    // Remove all filter-related params and reset pagination
    const keysToDelete = [];
    for (const key of params.keys()) {
        if (key.startsWith('filter.')) {
            keysToDelete.push(key);
        }
    }
    keysToDelete.forEach((key) => params.delete(key));
    params.delete('page');

    const newQueryString = params.toString();

    if (typeof FacetFiltersForm.renderPage === 'function') {
        if (typeof analytics !== 'undefined' && analytics && typeof analytics.trackClick === 'function') {
            analytics.trackClick('Filter select', {
                'Source': 'Catalogue',
                'Filter Name': 'Show All'
            });
        }
        FacetFiltersForm.renderPage(newQueryString, null, true);
        const event = new CustomEvent('collectionPageUpdated');
        window.dispatchEvent(event);

        // Remove all actice class
        document.querySelectorAll('.bubble-item').forEach(bubble => {
                bubble.classList.remove('active');
        });
    } else {
        const url = newQueryString ? `${window.location.pathname}?${newQueryString}` : window.location.pathname;
        window.location.href = url;
    }
  }

    function goToFilter(element, filterKey, filterValue) {
        if (typeof FacetFiltersForm.renderPage === 'function') {

            if (typeof analytics !== 'undefined' && analytics && typeof analytics.trackClick === 'function') {
                analytics.trackClick('Filter select', {
                    'Source': 'Catalogue',
                    'Filter Name': filterValue
                });
            }

            // Remove 'active' class from all bubble-items for this filterKey
            document.querySelectorAll(`.bubble-item[onclick*="'${filterKey}'"]`).forEach(bubble => {
                bubble.classList.remove('active');
            });

            // If this value is already selected, unselect it (remove filter for this key entirely)
            const params = new URLSearchParams(window.location.search);
            const currentValues = params.getAll(filterKey);

            const desiredValues = String(filterValue)
                .split(',')
                .map((v) => v.trim())
                .filter(Boolean);

            const sameValueSet = (a, b) => {
                const aSet = new Set(a);
                const bSet = new Set(b);
                if (aSet.size !== bSet.size) return false;
                for (const v of aSet) {
                    if (!bSet.has(v)) return false;
                }
                return true;
            };

            // Toggle off only if the current values for this key match this bubble exactly.
            if (desiredValues.length > 0 && sameValueSet(currentValues, desiredValues)) {
                params.delete(filterKey);
                element.classList.remove('active');
            } else {
                // Overwrite this filter key with all desired values (Shopify expects repeated params for multi-select).
                params.delete(filterKey);
                desiredValues.forEach((v) => params.append(filterKey, v));
                element.classList.add('active');
            }

            const newQueryString = params.toString();
            FacetFiltersForm.renderPage(newQueryString, null, true);

            // Dispatch the custom event
            const event = new CustomEvent('collectionPageUpdated');
            window.dispatchEvent(event);

        } else {
            console.log('filter failed: FacetFiltersForm not found or renderPage is not a function');
        }
    }

    function toggleSortMenu(button) {
      const menu = document.getElementById('sortDropdownMenu');
      if (menu) {
        const isOpen = menu.classList.toggle('show');
        // Optionally update aria-expanded for accessibility
        const expanded = button.getAttribute('aria-expanded') === 'true';
        button.setAttribute('aria-expanded', !expanded);
        // Lock or unlock body scroll when menu is open/closed
        if (isOpen && window.innerWidth <= 750) {
          document.body.classList.add('no-scroll');
        } else {
          document.body.classList.remove('no-scroll');
        }
      }
    }

    // ... (Place this code block inside your existing <script> tags) ...

    function highlightActiveFilters() {
        // 1. Get the current URL parameters
        const params = new URLSearchParams(window.location.search);
        const allActiveValues = {}; // An object to store active values for all keys
        
        // The filter keys used by your bubbles
        const filterKeys = ['filter.p.m.custom.coffee_roast_level', 'filter.p.m.custom.coffee_process']; 
        
        // 2. Get all active values for each filter key
        filterKeys.forEach(filterKey => {
            const activeValues = params.getAll(filterKey);
            if (activeValues.length > 0) {
                allActiveValues[filterKey] = activeValues;
            }
        });
        
        // Clear all existing active classes first
        document.querySelectorAll('.horizontal-bubbles-container .bubble-item').forEach(bubble => {
            bubble.classList.remove('active');
        });

        // Check if any filters are active
        const hasActiveFilters = Object.keys(allActiveValues).length > 0;
        
        if (!hasActiveFilters) {
            // If no filters are active, optionally highlight the 'Show All' bubble
            // const filterAllBubble = document.querySelector('.bubble-item.filter-all');
            // if (filterAllBubble) {
            //     filterAllBubble.classList.add('active');
            // }
            return; 
        }

        // 3. Loop through all bubble items and check if their value is in the active list
        document.querySelectorAll('.horizontal-bubbles-container .bubble-item').forEach(bubble => {
            // Extract the filter value from the onclick attribute
            const onclickAttr = bubble.getAttribute('onclick');
            
            // Use a regex to find the filterKey and filterValue in the goToFilter function call
            // Example: 'goToFilter(this, 'filter.p.m.custom.coffee_taste', 'Chocolate')'
            const match = onclickAttr.match(/goToFilter\([^,]+,\s*'([^']+)',\s*'([^']+)'\)/);

            if (match && match[1] && match[2]) {
                const bubbleFilterKey = match[1];
                const bubbleFilterValue = match[2];
                
                // Check if this filter key has active values
                if (allActiveValues[bubbleFilterKey]) {
                    const activeValues = allActiveValues[bubbleFilterKey];
                    
                    // Handle comma-separated values in the bubble
                    const bubbleValues = bubbleFilterValue.split(',').map(v => v.trim());
                    
                    // Check if ALL bubble values are in the list of active URL values
                    const allValuesActive = bubbleValues.every(value => activeValues.includes(value));
                    
                    if (allValuesActive && bubbleValues.length > 0) {
                        bubble.classList.add('active');
                    }
                }
            }
        });

        // OPTIONAL: Scroll the first active bubble into view if desired
        const firstActiveBubble = document.querySelector('.bubble-item.active');
        if (firstActiveBubble) {
            firstActiveBubble.scrollIntoView({
                behavior: 'smooth',
                block: 'nearest',
                inline: 'center'
            });
        }
    }

        document.addEventListener('DOMContentLoaded', highlightActiveFilters);
        // Also run immediately if the script loads after DOMContentLoaded fires
        if (document.readyState !== 'loading') {
            highlightActiveFilters();
        }

</script>