{{ 'horizontal-bubbles.css' | asset_url | stylesheet_tag }}
{{ 'component-show-more.css' | asset_url | stylesheet_tag }}

<style>
  .all-new-filters-wrapper {
    position: relative;
    z-index: 20; /* Ensure higher stacking context */
  }

  @media screen and (max-width: 750px) {
    .all-new-filters-wrapper {
      position: -webkit-sticky;
      position: sticky;
      top: calc(var(--header-height, 0px) + 10px);
      z-index: 10;
      transition: top 0.3s ease;
    }
    
    body.header-is-hidden .all-new-filters-wrapper {
      top: 10px;
    }
  }
</style>
<style>
  /* Menu Separation Logic */
  #sortDropdownMenu[data-mode="sort"] .dropdown-filter-wrapper:not(.sort-wrapper) {
    display: none !important;
  }
  #sortDropdownMenu[data-mode="sort"] .dropdown-filter-wrapper.sort-wrapper {
     /* display: flex !important; Restore display for sort wrapper */
  }

  #sortDropdownMenu[data-mode="filter"] .dropdown-filter-wrapper.sort-wrapper {
    display: none !important;
  }
  #sortDropdownMenu[data-mode="filter"] .dropdown-filter-wrapper:not(.sort-wrapper) {
    /*display: flex !important; /* Restore display for filter wrappers */
  }

  /* Sort Mode Specific Styles */
  #sortDropdownMenu[data-mode="sort"] {
    position: absolute;
    top: 100%;
    right: 0;
    width: max-content;
    min-width: 200px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 10px;
    z-index: 100;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    height: 165px;
  }

  @media screen and (min-width: 750px) {
    #sortDropdownMenu[data-mode="sort"] {
      right: 50px;
    }
  }

  /* Hide top and bottom bars in sort mode */
  #sortDropdownMenu[data-mode="sort"] .filter-top-menu-wrapper,
  #sortDropdownMenu[data-mode="sort"] .filter-bottom-menu-select {
    display: none !important;
  }

  /* Reveal sort items directly */
  #sortDropdownMenu[data-mode="sort"] .dropdown-filter-wrapper.sort-wrapper button.dropdown-button {
    display: none !important;
  }
  #sortDropdownMenu[data-mode="sort"] .dropdown-filter-wrapper.sort-wrapper .dropdown-menu {
    display: flex !important; /* Force open as flex column */
    box-shadow: none;
    border: none;
    position: static;
    width: 100%;
    margin-bottom: 0;
    flex-direction: column;
    gap: 0; /* Reset gap if needed */
  }
  #sortDropdownMenu[data-mode="sort"] .dropdown-filter-wrapper.sort-wrapper .dropdown-menu .dropdown-item {
       padding: 8px 0;
  }
  
  #sortDropdownMenu[data-mode="sort"] .sort-line-mobile {
    display: none !important;
  }
</style>

<div class="all-new-filters-wrapper">
 <button onclick="toggleSortMenu(this, 'sort_icon', 'sort')" class="sort-dropdown-button short-button" type="button" aria-expanded="false" aria-haspopup="true">
    <img class="sort-icon-image" src="{{ 'sort-icon-catalogue.svg' | asset_url }}" alt="sort icon"/>
  </button>
  <button onclick="toggleSortMenu(this, 'filter_text', 'filter')" class="sort-dropdown-button" type="button" aria-expanded="false" aria-haspopup="true">
    <span>סינון וחיפוש</span>
    {% comment %} <div style="position: relative">
      <img class="sort-icon-image" src="{{ 'sort-icon-image.png' | asset_url }}" alt="sort icon"/>
      <div class="sort-icon-image-selected {% if content_for_header contains 'filter.p.' or content_for_header contains 'filter.v.' or content_for_header contains 'sort_by=' %}show{% endif %}">&nbsp;</div>
    </div> {% endcomment %}
  </button>

  <div class="sort-dropdown-menu" id="sortDropdownMenu">
    {% assign product_taste = collection.products %} 
    {% render 'taste-filter', tastes: product_taste, results: results %} 
  </div>
</div>

  
<script>

  function removeAllFilters() {
    const params = new URLSearchParams(window.location.search);
    // Remove all filter-related params and reset pagination
    const keysToDelete = [];
    for (const key of params.keys()) {
        if (key.startsWith('filter.')) {
            keysToDelete.push(key);
        }
    }
    keysToDelete.forEach((key) => params.delete(key));
    params.delete('page');

    const newQueryString = params.toString();

    if (typeof FacetFiltersForm.renderPage === 'function') {
        if (typeof analytics !== 'undefined' && analytics && typeof analytics.trackClick === 'function') {
            analytics.trackClick('Filter select', {
                'Source': 'Catalogue',
                'Filter Name': 'Show All'
            });
        }
        FacetFiltersForm.renderPage(newQueryString, null, true);
        const event = new CustomEvent('collectionPageUpdated');
        window.dispatchEvent(event);

        // Remove all actice class
        document.querySelectorAll('.bubble-item').forEach(bubble => {
                bubble.classList.remove('active');
        });
    } else {
        const url = newQueryString ? `${window.location.pathname}?${newQueryString}` : window.location.pathname;
        window.location.href = url;
    }
  }

    function goToFilter(element, filterKey, filterValue) {
        if (typeof FacetFiltersForm.renderPage === 'function') {

            if (typeof analytics !== 'undefined' && analytics && typeof analytics.trackClick === 'function') {
                analytics.trackClick('Filter select', {
                    'Source': 'Catalogue',
                    'Filter Name': filterValue
                });
            }

            // Remove 'active' class from all bubble-items for this filterKey
            document.querySelectorAll(`.bubble-item[onclick*="'${filterKey}'"]`).forEach(bubble => {
                bubble.classList.remove('active');
            });

            // If this value is already selected, unselect it (remove filter for this key entirely)
            const params = new URLSearchParams(window.location.search);
            const currentValues = params.getAll(filterKey);

            const desiredValues = String(filterValue)
                .split(',')
                .map((v) => v.trim())
                .filter(Boolean);

            const sameValueSet = (a, b) => {
                const aSet = new Set(a);
                const bSet = new Set(b);
                if (aSet.size !== bSet.size) return false;
                for (const v of aSet) {
                    if (!bSet.has(v)) return false;
                }
                return true;
            };

            // Toggle off only if the current values for this key match this bubble exactly.
            if (desiredValues.length > 0 && sameValueSet(currentValues, desiredValues)) {
                params.delete(filterKey);
                element.classList.remove('active');
            } else {
                // Overwrite this filter key with all desired values (Shopify expects repeated params for multi-select).
                params.delete(filterKey);
                desiredValues.forEach((v) => params.append(filterKey, v));
                element.classList.add('active');
            }

            const newQueryString = params.toString();
            FacetFiltersForm.renderPage(newQueryString, null, true);

            // Dispatch the custom event
            const event = new CustomEvent('collectionPageUpdated');
            window.dispatchEvent(event);

        } else {
            console.log('filter failed: FacetFiltersForm not found or renderPage is not a function');
        }
    }

function toggleSortMenu(button, source = null, mode = null) {
  const menu = document.getElementById('sortDropdownMenu');
  if (mode && menu) {
    menu.setAttribute('data-mode', mode);
  }
  if (source) {
    analytics.trackClick(`Filter ${source}`);
  }
  if (menu) {
    const isOpen = menu.classList.toggle('show');
    const expanded = button.getAttribute('aria-expanded') === 'true';
    button.setAttribute('aria-expanded', !expanded);

    if (isOpen) {
      // Mobile: Lock scroll
      analytics.trackClick('Filter Menu Open', { 'mode': mode });
      if (window.innerWidth <= 750) {
        document.body.classList.add('no-scroll');
      } else {
        // document.body.classList.add('filter-open');
      }
    } else {
      analytics.trackClick('Filter Menu Close');
      // Cleanup: Remove both classes when closing
      document.body.classList.remove('no-scroll');
      // document.body.classList.remove('filter-open');
    }
  }
}

function closeSortMenu() {
  const menu = document.getElementById('sortDropdownMenu');
  if (menu && menu.classList.contains('show')) {
      menu.classList.remove('show');
      document.body.classList.remove('no-scroll');
      // Update aria-expanded for buttons that control this menu
      document.querySelectorAll('.sort-dropdown-button[aria-expanded="true"]').forEach(btn => {
          btn.setAttribute('aria-expanded', 'false');
      });
  }
}

    // ... (Place this code block inside your existing <script> tags) ...

    function highlightActiveFilters() {
        // 1. Get the current URL parameters
        const params = new URLSearchParams(window.location.search);
        const allActiveValues = {}; // An object to store active values for all keys
        
        // The filter keys used by your bubbles
        const filterKeys = ['filter.p.m.custom.coffee_roast_level', 'filter.p.m.custom.coffee_process']; 
        
        // 2. Get all active values for each filter key
        filterKeys.forEach(filterKey => {
            const activeValues = params.getAll(filterKey);
            if (activeValues.length > 0) {
                allActiveValues[filterKey] = activeValues;
            }
        });
        
        // Clear all existing active classes first
        document.querySelectorAll('.horizontal-bubbles-container .bubble-item').forEach(bubble => {
            bubble.classList.remove('active');
        });

        // Check if any filters are active
        const hasActiveFilters = Object.keys(allActiveValues).length > 0;
        
        if (!hasActiveFilters) {
            // If no filters are active, optionally highlight the 'Show All' bubble
            // const filterAllBubble = document.querySelector('.bubble-item.filter-all');
            // if (filterAllBubble) {
            //     filterAllBubble.classList.add('active');
            // }
            return; 
        }

        // 3. Loop through all bubble items and check if their value is in the active list
        document.querySelectorAll('.horizontal-bubbles-container .bubble-item').forEach(bubble => {
            // Extract the filter value from the onclick attribute
            const onclickAttr = bubble.getAttribute('onclick');
            
            // Use a regex to find the filterKey and filterValue in the goToFilter function call
            // Example: 'goToFilter(this, 'filter.p.m.custom.coffee_taste', 'Chocolate')'
            const match = onclickAttr.match(/goToFilter\([^,]+,\s*'([^']+)',\s*'([^']+)'\)/);

            if (match && match[1] && match[2]) {
                const bubbleFilterKey = match[1];
                const bubbleFilterValue = match[2];
                
                // Check if this filter key has active values
                if (allActiveValues[bubbleFilterKey]) {
                    const activeValues = allActiveValues[bubbleFilterKey];
                    
                    // Handle comma-separated values in the bubble
                    const bubbleValues = bubbleFilterValue.split(',').map(v => v.trim());
                    
                    // Check if ALL bubble values are in the list of active URL values
                    const allValuesActive = bubbleValues.every(value => activeValues.includes(value));
                    
                    if (allValuesActive && bubbleValues.length > 0) {
                        bubble.classList.add('active');
                    }
                }
            }
        });

        // OPTIONAL: Scroll the first active bubble into view if desired
        const firstActiveBubble = document.querySelector('.bubble-item.active');
        if (firstActiveBubble) {
            firstActiveBubble.scrollIntoView({
                behavior: 'smooth',
                block: 'nearest',
                inline: 'center'
            });
        }
    }

        document.addEventListener('DOMContentLoaded', highlightActiveFilters);
        // Also run immediately if the script loads after DOMContentLoaded fires
        if (document.readyState !== 'loading') {
            highlightActiveFilters();
        }

</script>