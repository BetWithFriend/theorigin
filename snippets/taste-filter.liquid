<!-- snippets/filter-dropdown.liquid -->

<div class="dropdown-filters">
  <button id="dropdown-button-taste" class="dropdown-button" onclick="toggleDropdown('taste')">
      טעם
      <div class="selected-icons" id="selected-icons-taste"></div>
    <img src="{{ 'dropdown-icon.png' | asset_url }}" alt="Dropdown Icon" class="dropdown-icon" />
  </button>
  <div class="dropdown-divider"> </div>
  <button id="dropdown-button-prep" class="dropdown-button" onclick="toggleDropdown('prep')">
      הכנה
      <div class="selected-icons" id="selected-icons-prep"></div>
    <img src="{{ 'dropdown-icon.png' | asset_url }}" alt="Dropdown Icon" class="dropdown-icon" />
  </button>
  <div class="dropdown-menu-wrapper">
    <div class="dropdown-menu" id="dropdownMenu-taste">

      <div class="dropdown-item">
        <label class="dropdown-icons">
          <input class="dropdown-icons-input" type="checkbox" name="Fruity" value="Fruity">
          <span class="color-circle" style="background-color: #FFDF70;"></span>
          <span>פירותי</span>
        </label>
      </div>
      <div class="dropdown-item">
        <label class="dropdown-icons">
        <input class="dropdown-icons-input"  type="checkbox" name="Fruity-Sweet" value="Fruity-Sweet">
        <span class="color-circle" style="background-color: #FF974A;"></span>
        <span>פירותי מתוק</span>
        </label>
      </div>
      <div class="dropdown-item" >
        <label class="dropdown-icons">
          <input class="dropdown-icons-input"  type="checkbox" name="Sweet" value="Sweet">
          <span class="color-circle" style="background-color: #D60540;"></span>
          <span>מתוק מאוזן</span>
        </label>
      </div>
      <div class="dropdown-item" >
        <label class="dropdown-icons">
          <input class="dropdown-icons-input"  type="checkbox" name="Sweet-Chocolate" value="Sweet-Chocolate">
          <span class="color-circle" style="background-color: #C4823E;"></span>
          <span>מתוק שוקולדי</span>
        </label>
      </div>
      <div class="dropdown-item" >
        <label class="dropdown-icons">
          <input class="dropdown-icons-input"  type="checkbox" name="Chocolate" value="Chocolate">
          <span class="color-circle" style="background-color: #8B4513;"></span>
          <span>שוקולדי</span>
        </label>
      </div>
      <div class="dropdown-menu-btn" data-type="taste" onclick="filterByTag('taste')">הצג הכל</div>
    </div>

    <div class="dropdown-menu" id="dropdownMenu-prep">
        <div class="dropdown-item">
        <label class="dropdown-icons">
          <input class="dropdown-icons-input"  type="checkbox" name="Filter" value="Filter">
          <img class="dropdown-icon-img" src="{{ 'dropdown-brew-Filter.png' | asset_url }}" alt="Filter Icon" /> 
          <span>פילטר</span>
          </label>
        </div>
        <div class="dropdown-item">
          <label class="dropdown-icons">
            <input class="dropdown-icons-input"  type="checkbox" name="Black" value="Black">
            <img class="dropdown-icon-img" src="{{ 'dropdown-brew-Turkish.png' | asset_url }}" alt="Turkish Icon" /> 
            <span>קפה שחור</span>
          </label>
        </div>
        <div class="dropdown-item">
          <label class="dropdown-icons">
            <input class="dropdown-icons-input"  type="checkbox" name="Moka" value="Moka">
            <img class="dropdown-icon-img" src="{{ 'dropdown-brew-Moka.png' | asset_url }}" alt="Espresso Icon" /> 
            <span>מקינטה</span>
          </label>
        </div>
        <div class="dropdown-item">
          <label class="dropdown-icons">
            <input class="dropdown-icons-input"  type="checkbox" name="Espresso" value="Espresso">
            <img class="dropdown-icon-img" src="{{ 'dropdown-brew-Espresso-Machine.png' | asset_url }}" alt="Espresso Icon" /> 
            <span>אספרסו</span>
          </label>
        </div>
        <div class="dropdown-item">
          <label class="dropdown-icons">
            <input class="dropdown-icons-input"  type="checkbox" name="Chemex" value="Chemex">
            <img class="dropdown-icon-img " src="{{  'dropdown-brew-Chemex.png' | asset_url }}" alt="Moka Icon" />
            <span>חליטה</span>
          </label>
        </div>
        <div class="dropdown-menu-btn" data-type="prep" onclick="filterByTag('prep')">הצג הכל</div>
    </div>
  </div>
</div>


<style>
  .dropdown-menu-wrapper {
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .dropdown-filters {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
  }
  .dropdown-hidden {
    visibility: hidden
  }

  .dropdown-button {
    height: 60px;
    font-family:  'Noto Sans', sans-serif;
    width: 100%;
    color: #767676;
    background-color: #ffffff;
    /* border: 1px solid #0000001A; */
    padding: 11px 16px;
    text-align: center;
    font-size: 16px;
    cursor: pointer;
    font-weight: 400;
    /* border-radius: 4px; */
    display: flex;
    align-items: center;
    /* flex-direction: row-reverse; */
    justify-content: center;
  }

  .dropdown-menu {
    display: none;
    position: absolute;
    border: 1px solid #DEDBD666;
    border-radius: 4px;
    width: 47%;
    background-color: #fff;
    border: 1px solid #ddd;
    z-index: 10;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  #dropdownMenu-taste {
    top: 60px;
    right: 0;
    gap: 32px;
    padding: 16px;
    width: 200px;
  }
  #dropdownMenu-prep {
    top: 60px;
    left: 0;
    gap: 32px;
    padding: 16px;
    width: 200px;
  }

  .dropdown-item {
    /* padding: 8px 8px; */
    display: flex;
    justify-content: start;
    align-items: center;
    cursor: pointer;
    width: 100%;
  }

  .dropdown-item:hover {
    background-color: #f4f4f4;
  }

  .dropdown-icons {
    display: flex;
    align-items: center;
    /* gap: 8px; */
    white-space: nowrap;
  }
  .dropdown-icon {
    width: 12px;
  }

  .dropdown-icons-input {
    width: 22px !important;
    height: 22px !important;
    margin-left: 10px;
  }

  .color-circle {
    width: 24px;
    height: 24px;
    border-radius: 30px;
    margin-left: 8px;
  }

  .dropdown-button {
  /* background: url("{{ 'dropdown-icon.svg' | asset_url }}") no-repeat right center; */
  /* background-size: 16px;
  padding-right: 24px;  */
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 16px;
  width: 30%;
  border: none;
}

.dropdown-divider {
  border: 1px solid #CDCDCD;
    width: 1px;
    display: block;
    height: 45px;
}

.dropdown-icon-img {
  height: 24px;
  width: 24px;
}

.dropdown-menu-btn {
  background-color: #1C201D;
  width: 113px;
  height: 40px;
  border-radius: 8px;
  padding: 16px 10px;
  font-family:  'Noto Sans', sans-serif;
  font-size: 18px;
  color: #E3E0DA;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 16px 0;
}

.selected-icons {
  display: flex;
  gap: 4px;
  /* margin-left: 4px; */
}

#selected-icons-taste .color-circle,
#selected-icons-prep img {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  margin-left: 0;
}
</style>

<script>
  function toggleDropdown(menuType) {
    // Close the opened menu when selection second menu
    const menuTaste = document.getElementById('dropdownMenu-taste')
    const menuPrep = document.getElementById('dropdownMenu-prep')
    if (menuType === 'taste') { 
      menuPrep.style.display = 'none'
    } else {
      menuTaste.style.display = 'none'
    }
    const menu = document.getElementById('dropdownMenu-' + menuType);
    menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex';
    menu.style.flexDirection = menu.style.display === 'flex' ? 'column' : 'flex';
    menu.style.alignItems = menu.style.display === 'flex' ? 'center' : 'flex';
    menu.style.justifyContent = menu.style.display === 'flex' ? 'end' : 'flex';
    menu.style.gpa = menu.style.display === '8px' ? 'end' : '8px';
    menu.style.margin = menu.style.display === '0px 10px' ? 'end' : '0px 10px';
    menu.style.paddingTop = menu.style.display === 'flex' ? '16px' : '0px';
  }

  function filterByTag() {
  // Gather checked checkboxes from both dropdowns
  const tasteChecked = Array.from(document.querySelectorAll('#dropdownMenu-taste .dropdown-icons-input:checked'))
    .map(checkbox => checkbox.value);
  const prepChecked = Array.from(document.querySelectorAll('#dropdownMenu-prep .dropdown-icons-input:checked'))
    .map(checkbox => checkbox.value);

  document.querySelectorAll('.grid__item').forEach(card => {
    const prepMethods = card.dataset.prepMethods;

    if (!prepMethods) return;

    const flavorPart = prepMethods.substring(0, prepMethods.indexOf('[')).trim();
    const methodsString = prepMethods.substring(prepMethods.indexOf('['));
    const methodsArray = JSON.parse(methodsString);

    // OR logic inside each category
    const tasteMatch = tasteChecked.length === 0 || tasteChecked.includes(flavorPart);
    const prepMatch = prepChecked.length === 0 || prepChecked.some(tag => methodsArray.includes(tag));

    // AND logic between taste and prep
    const show = tasteMatch && prepMatch;
    card.style.display = show ? 'block' : 'none';

    // Close the menu after selecting
    const menuTaste = document.getElementById('dropdownMenu-taste');
    const menuPrep = document.getElementById('dropdownMenu-prep');
    menuPrep.style.display = 'none';
    menuTaste.style.display = 'none';
  });
  updateDropdownButtonText('taste');
  updateDropdownButtonText('prep');
}

// document.querySelectorAll('.dropdown-icons-input').forEach(input => {
//   input.addEventListener('change', () => {
//     updateDropdownButtonText('taste');
//     updateDropdownButtonText('prep');
//   });
// });

function updateDropdownButtonText(type) {
  const selectedCheckboxes = document.querySelectorAll(`#dropdownMenu-${type} .dropdown-icons-input:checked`);
  const button = document.querySelector(`.dropdown-menu-btn[data-type="${type}"]`);
  
  if (selectedCheckboxes.length > 0) {
    button.textContent = 'בחר';
  } else {
    button.textContent = `הצג הכל`;
  }
}

function updateDropdownButtonText(type) {
  const selectedCheckboxes = document.querySelectorAll(`#dropdownMenu-${type} .dropdown-icons-input:checked`);
  const button = document.querySelector(`.dropdown-menu-btn[data-type="${type}"]`);
  
  if (selectedCheckboxes.length > 0) {
    button.textContent = 'בחר';
  } else {
    button.textContent = `הצג הכל`;
  }

  // Now update the small icons/colors on the main button
  const selectedIconsContainer = document.getElementById(`selected-icons-${type}`);
  selectedIconsContainer.innerHTML = ''; // Clear previous

  selectedCheckboxes.forEach((checkbox, index) => {
    if (index >= 3) return; // Max 3 icons

    const label = checkbox.closest('label');
    if (type === 'taste') {
      // Clone the color-circle
      const colorCircle = label.querySelector('.color-circle');
      if (colorCircle) {
        const clone = colorCircle.cloneNode(true);
        selectedIconsContainer.appendChild(clone);
      }
    } else if (type === 'prep') {
      // Clone the icon img
      const iconImg = label.querySelector('.dropdown-icon-img');
      if (iconImg) {
        const clone = iconImg.cloneNode(true);
        selectedIconsContainer.appendChild(clone);
      }
    }
  });
}
</script>
